generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. ENUMS (Status & Roles)
// ==========================================

enum Role {
  CUSTOMER
  VENDOR
  ADMIN
}

enum PricingType {
  HOURLY
  DAILY
  WEEKLY
  CUSTOM
}

enum OrderStatus {
  DRAFT       // Quotation Phase
  SENT        // Quotation Sent to Customer
  CONFIRMED   // Order Confirmed / Stock Reserved
  PICKED_UP   // Item with Customer
  RETURNED    // Item Returned
  COMPLETED   // Inspection Done & Closed
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PARTIALLY_PAID
  PAID
  OVERDUE
}

enum PaymentMethod {
  CARD
  UPI
  CASH
  BANK_TRANSFER
}

// ==========================================
// 2. USER MANAGEMENT
// ==========================================

model User {
  id              Int      @id @default(autoincrement())
  email           String   @unique
  password        String
  firstName       String
  lastName        String
  role            Role     @default(CUSTOMER)

  // Vendor Details
  companyName     String?
  gstin           String?
  productCategory String?

  // Relations
  products        Product[] @relation("VendorProducts")
  orders          Order[]   @relation("CustomerOrders")
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ==========================================
// 3. PRODUCT MANAGEMENT
// ==========================================

model Product {
  id            Int           @id @default(autoincrement())
  name          String
  description   String?
  brand         String?
  
  // Pricing & Inventory
  pricingType   PricingType   @default(DAILY)
  price         Decimal       // Base rate (e.g., per day)
  securityDeposit Decimal     @default(0)
  quantity      Int           @default(1) // Total stock on hand
  
  // Status
  isRentable    Boolean       @default(true)
  isPublished   Boolean       @default(true)

  // Relations
  vendorId      Int
  vendor        User          @relation("VendorProducts", fields: [vendorId], references: [id])
  attributes    ProductAttribute[]
  orderItems    OrderItem[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model ProductAttribute {
  id        Int     @id @default(autoincrement())
  name      String  // e.g., "Color", "Size"
  value     String  // e.g., "Red", "Large"
  
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

// ==========================================
// 4. ORDER & RESERVATION SYSTEM
// ==========================================

model Order {
  id            Int         @id @default(autoincrement())
  orderNumber   String      @unique // e.g., ORD-1001
  status        OrderStatus @default(DRAFT) // DRAFT = Quotation

  // Rental Dates (Global for the order)
  startDate     DateTime
  endDate       DateTime

  // Financials
  totalAmount   Decimal
  taxAmount     Decimal     @default(0)
  
  // Pickup & Return Info
  pickupNotes   String?
  returnNotes   String?
  
  // Relations
  customerId    Int
  customer      User        @relation("CustomerOrders", fields: [customerId], references: [id])
  items         OrderItem[]
  invoices      Invoice[]

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

model OrderItem {
  id          Int      @id @default(autoincrement())
  
  // Rental specifics for this item
  quantity    Int
  priceAtBooking Decimal // Snapshots price to prevent changes if product price updates
  
  startDate   DateTime // Allows split-dates in future if needed
  endDate     DateTime
  
  // Relations
  orderId     Int
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   Int
  product     Product  @relation(fields: [productId], references: [id])
}

// ==========================================
// 5. INVOICING & PAYMENTS
// ==========================================

model Invoice {
  id            Int           @id @default(autoincrement())
  invoiceNumber String        @unique // e.g., INV-2024-001
  status        InvoiceStatus @default(DRAFT)
  
  totalAmount   Decimal
  paidAmount    Decimal       @default(0)
  balanceAmount Decimal       // Calculated in logic (total - paid)
  
  dueDate       DateTime
  
  // Relations
  orderId       Int
  order         Order         @relation(fields: [orderId], references: [id])
  payments      Payment[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Payment {
  id            Int           @id @default(autoincrement())
  amount        Decimal
  method        PaymentMethod
  transactionId String?       // From Stripe/Razorpay
  
  paymentDate   DateTime      @default(now())
  
  invoiceId     Int
  invoice       Invoice       @relation(fields: [invoiceId], references: [id])
}